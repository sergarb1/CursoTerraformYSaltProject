<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cheat Sheet · UD04 – Bloques avanzados, bucles y dependencias</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body{margin:0;font-family:'Inter',sans-serif;background:#f9fafc;color:#1e1e1e;line-height:1.6;padding:24px}
    h1,h2,h3{color:#0052cc}
    h1{font-size:2em;margin-bottom:0.3em}
    h2{border-bottom:2px solid #e5e7eb;padding-bottom:0.2em;margin-top:1em}
    code,pre{background:#f0f2f5;color:#111;padding:4px 6px;border-radius:6px;font-size:0.9em}
    pre{padding:12px;overflow-x:auto}
    .tip{background:#e8f2ff;border-left:4px solid #0052cc;padding:10px;border-radius:8px;margin:10px 0}
    .warn{background:#fff6e5;border-left:4px solid #ff9f1c;padding:10px;border-radius:8px;margin:10px 0}
    .ok{background:#e8f8f0;border-left:4px solid #2ecc71;padding:10px;border-radius:8px;margin:10px 0}
    ul{margin-left:20px}
    section{margin-bottom:30px;padding:20px;background:#ffffff;border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,.05)}
    i{color:#0052cc;margin-right:6px}
  </style>
</head>
<body>

<h1><i class="bi bi-infinity"></i>UD04 · Bloques avanzados, bucles y dependencias en Terraform</h1>
<p>Guía práctica para usar lógica dinámica en Terraform: bucles, condicionales, dependencias y módulos reutilizables.</p>

<section>
<h2><i class="bi bi-rocket-takeoff"></i> 1 · Control dinámico de recursos</h2>
<ul>
  <li><i class="bi bi-list-ol"></i> <code>count</code> y <code>for_each</code> para crear recursos repetidos</li>
  <li><i class="bi bi-question-circle"></i> <code>condicionales</code> con operadores ternarios</li>
  <li><i class="bi bi-diagram-3"></i> <code>depends_on</code> para definir orden de creación</li>
</ul>
<div class="ok"><i class="bi bi-check2"></i> Mejora la <strong>escalabilidad</strong>, <strong>mantenibilidad</strong> y <strong>reutilización</strong> del código</div>
</section>

<section>
<h2><i class="bi bi-123"></i> 2 · Repetición con count</h2>
<p>Para crear múltiples instancias del mismo recurso:</p>
<pre><code>resource "docker_container" "web" {
  count = 3
  name  = "web-${count.index}"
  image = "nginx:latest"
}</code></pre>
<div class="tip"><i class="bi bi-lightbulb"></i> Accede a cada uno con <code>docker_container.web[0]</code>, <code>[1]</code>, etc.</div>

<h3><i class="bi bi-sliders2-vertical"></i> Activación condicional</h3>
<pre><code>count = var.enable_logs ? 1 : 0</code></pre>
<p>Ideal para entornos con recursos opcionales.</p>
</section>

<section>
<h2><i class="bi bi-arrow-repeat"></i> 3 · Iteración con for_each</h2>
<p>Perfecto para recursos con valores únicos:</p>

<pre><code>variable "users" {
  default = ["alice", "bob"]
}
resource "local_file" "user_file" {
  for_each = toset(var.users)
  filename = "${each.key}.txt"
  content  = "Hola ${each.key}"
}</code></pre>

<h3><i class="bi bi-key"></i> Uso con mapas</h3>
<pre><code>variable "contenedores" {
  default = {
    nginx1 = 8081
    nginx2 = 8082
  }
}
resource "docker_container" "nginx" {
  for_each = var.contenedores
  name     = each.key
  ports {
    internal = 80
    external = each.value
  }
}</code></pre>
</section>

<section>
<h2><i class="bi bi-link-45deg"></i> 4 · Dependencias con depends_on</h2>
<p>Fuerza el orden de creación entre recursos:</p>
<pre><code>resource "docker_container" "nginx" {
  depends_on = [docker_network.red_local]
  ...
}</code></pre>
<ul>
  <li><i class="bi bi-check-circle"></i> Útil cuando no hay referencia directa entre recursos</li>
  <li><i class="bi bi-exclamation-circle"></i> No abuses del uso innecesario</li>
</ul>
</section>

<section>
<h2><i class="bi bi-code-slash"></i> 5 · Condicionales</h2>
<p>Uso de operadores ternarios:</p>
<pre><code>image = var.env == "prod" ? "nginx:stable" : "nginx:alpine"</code></pre>

<h3><i class="bi bi-toggle-on"></i> Activar/desactivar recursos</h3>
<pre><code>count = var.deploy_container ? 1 : 0</code></pre>
<div class="warn"><i class="bi bi-exclamation-triangle"></i> Ambas ramas se evalúan, incluso si una no se usa</div>
</section>

<section>
<h2><i class="bi bi-tools"></i> 6 · Funciones integradas</h2>
<ul>
  <li><code>length(var.list)</code> → cuenta elementos</li>
  <li><code>join("-", ["web", "01"])</code> → "web-01"</li>
  <li><code>split("-", "web-prod")</code> → ["web", "prod"]</li>
  <li><code>lookup(var.map, "key", "default")</code></li>
  <li><code>replace("v1.0", ".", "-")</code> → "v1-0"</li>
</ul>

<h3><i class="bi bi-output"></i> Combinación con outputs</h3>
<pre><code>locals {
  nombre = upper("web")
}
output "nombre_upper" {
  value = local.nombre
}</code></pre>
</section>

<section>
<h2><i class="bi bi-boxes"></i> 7 · Módulos en Terraform</h2>
<p>Permiten reutilizar lógica y organizar mejor tu infraestructura:</p>

<h3><i class="bi bi-diagram-3-fill"></i> Estructura mínima:</h3>
<ul>
  <li><code>main.tf</code></li>
  <li><code>variables.tf</code></li>
  <li><code>outputs.tf</code></li>
</ul>

<h3><i class="bi bi-gear-fill"></i> Uso del módulo</h3>
<pre><code>module "file1" {
  source   = "./modules/files"
  filename = "saludo.txt"
  content  = "Hola desde el módulo"
}
output "archivo" {
  value = module.file1.file_path
}</code></pre>

<div class="tip"><i class="bi bi-lightbulb"></i> Puedes usar módulos locales o del Terraform Registry</div>
</section>

<p style="text-align:center;color:#0052cc;margin-top:40px"><i class="bi bi-mortarboard"></i> Cheat Sheet UD04</p>
</body>
</html>
